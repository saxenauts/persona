{% extends "base.html" %}

{% block title %}{{ result.question_id }} - Eval Explorer{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/">Runs</a> <span>/</span> 
    {% if run_id %}<a href="/run/{{ run_id }}" class="text-mono">{{ run_id }}</a> <span>/</span> {% endif %}
    <span class="current text-mono">{{ result.question_id }}</span>
</div>

<!-- Header -->
<div class="card">
    <div class="card-body">
        <div class="flex justify-between items-start">
            <div class="flex-1" style="padding-right: 32px;">
                <h3 class="card-title" style="font-size: 18px; margin-bottom: 16px;">{{ result.question_text }}</h3>
                
                <div class="grid grid-2">
                    <div style="background: rgba(35, 134, 54, 0.1); padding: 12px; border-radius: var(--radius-md); border: 1px solid rgba(35, 134, 54, 0.2);">
                        <div class="text-small text-success font-bold mb-2">EXPECTED</div>
                        <div class="text-mono" style="word-break: break-all;">{{ result.gold_answer }}</div>
                    </div>
                    <div style="background: {% if result.correct %}rgba(35, 134, 54, 0.1){% else %}rgba(218, 54, 51, 0.1){% endif %}; padding: 12px; border-radius: var(--radius-md); border: 1px solid {% if result.correct %}rgba(35, 134, 54, 0.2){% else %}rgba(218, 54, 51, 0.2){% endif %};">
                        <div class="text-small font-bold mb-2 {% if result.correct %}text-success{% else %}text-danger{% endif %}">GENERATED</div>
                        <div class="text-mono" style="word-break: break-all;">{{ result.generated_answer or 'None' }}</div>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-col items-end gap-2" style="min-width: 140px;">
                {% if result.correct %}
                <span class="badge badge-success" style="font-size: 14px; padding: 6px 12px;">PASSED</span>
                {% else %}
                <span class="badge badge-danger" style="font-size: 14px; padding: 6px 12px;">FAILED</span>
                {% endif %}
                
                <span class="badge badge-neutral text-mono">{{ result.question_type }}</span>
                
                {% if result.failure_category %}
                <span class="badge badge-warning">{{ result.failure_category }}</span>
                {% endif %}
                
                <div class="text-small text-muted mt-2">
                    Total: {{ "%.2f"|format(result.duration_s) if result.duration_s else 0 }}s
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pipeline Timing Table -->
{% if pipeline %}
    {% set ing_ms = pipeline.ingestion.duration_ms or 0 %}
    {% set ret_ms = pipeline.retrieval.duration_ms or 0 %}
    {% set gen_ms = pipeline.generation.duration_ms or 0 %}
    {% set total_ms = ing_ms + ret_ms + gen_ms %}
    
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Execution Pipeline</h3>
        </div>
        <div class="table-wrapper" style="border: none;">
            <table>
                <thead>
                    <tr>
                        <th>Stage</th>
                        <th class="text-right">Duration</th>
                        <th class="text-right">% of Total</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span style="display: inline-block; width: 10px; height: 10px; border-radius: 2px; background: var(--color-primary); margin-right: 8px;"></span>Ingestion</td>
                        <td class="text-right text-mono">{{ "%.2f"|format(ing_ms/1000) }}s</td>
                        <td class="text-right text-mono text-muted">{{ "%.1f"|format(ing_ms/total_ms*100 if total_ms > 0 else 0) }}%</td>
                        <td class="text-small text-muted">{{ pipeline.ingestion.nodes or 0 }} nodes, {{ pipeline.ingestion.relationships or 0 }} edges</td>
                    </tr>
                    <tr>
                        <td><span style="display: inline-block; width: 10px; height: 10px; border-radius: 2px; background: var(--color-warning); margin-right: 8px;"></span>Retrieval</td>
                        <td class="text-right text-mono">{{ "%.2f"|format(ret_ms/1000) }}s</td>
                        <td class="text-right text-mono text-muted">{{ "%.1f"|format(ret_ms/total_ms*100 if total_ms > 0 else 0) }}%</td>
                        <td class="text-small text-muted">{{ pipeline.retrieval.nodes_retrieved or 0 }} nodes, {{ pipeline.retrieval.edges_retrieved or 0 }} edges</td>
                    </tr>
                    <tr>
                        <td><span style="display: inline-block; width: 10px; height: 10px; border-radius: 2px; background: var(--color-success); margin-right: 8px;"></span>Generation</td>
                        <td class="text-right text-mono">{{ "%.2f"|format(gen_ms/1000) }}s</td>
                        <td class="text-right text-mono text-muted">{{ "%.1f"|format(gen_ms/total_ms*100 if total_ms > 0 else 0) }}%</td>
                        <td class="text-small text-muted">{{ pipeline.generation.model or 'unknown' }}, {{ pipeline.generation.prompt_tokens or 0 }} tokens</td>
                    </tr>
                    <tr style="font-weight: 600; border-top: 2px solid var(--border-default);">
                        <td>Total</td>
                        <td class="text-right text-mono">{{ "%.2f"|format(total_ms/1000) }}s</td>
                        <td class="text-right text-mono text-muted">100%</td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
{% endif %}

<!-- Tabs Area -->
<div class="tab-container">
    <div class="tabs">
        <button class="tab-btn active" data-target="tab-sessions">Sessions ({{ sessions|length if sessions else 0 }})</button>
        <button class="tab-btn" data-target="tab-ingestion">Ingestion</button>
        <button class="tab-btn" data-target="tab-retrieval">Retrieval ({{ retrieved_nodes|length }})</button>
        <button class="tab-btn" data-target="tab-gen">Generation</button>
        <button class="tab-btn" data-target="tab-raw">Raw Log</button>
    </div>

    <!-- Sessions Tab -->
    <div id="tab-sessions" class="tab-content active">
        {% if sessions %}
        <div class="flex justify-between mb-4">
            <div class="flex gap-4 items-center">
                <div class="flex items-center gap-2 text-small text-muted">
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-success);"></div>
                    Contains Gold Answer
                </div>
            </div>
            <div class="flex gap-2">
                <button class="btn btn-sm" onclick="document.querySelectorAll('details').forEach(d => d.open = true)">Expand All</button>
                <button class="btn btn-sm" onclick="document.querySelectorAll('details').forEach(d => d.open = false)">Collapse All</button>
            </div>
        </div>
        
        <div class="flex flex-col gap-2">
            {% for session in sessions %}
            <details class="card" style="margin-bottom: 0; padding: 0; overflow: hidden; border-color: {% if session.contains_gold %}var(--color-success-fg){% else %}var(--border-default){% endif %};">
                <summary style="padding: 12px 16px; background: var(--bg-card-hover); cursor: pointer; font-weight: 500; display: flex; align-items: center; justify-content: space-between;">
                    <div class="flex items-center gap-2">
                        <span>Session {{ loop.index }}</span>
                        <span class="text-muted text-small text-mono">({{ session.turns|length }} turns)</span>
                    </div>
                    {% if session.contains_gold %}
                    <span class="badge badge-success text-small">Found Answer</span>
                    {% endif %}
                </summary>
                <div class="card-body bg-body" style="background: var(--bg-body);">
                    <div class="chat-stream">
                        {% for turn in session.turns %}
                        <div class="chat-bubble chat-{{ turn.role|lower }}">
                            <span class="chat-meta">{{ turn.role }}</span>
                            <div style="white-space: pre-wrap;">{{ turn.content }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </details>
            {% endfor %}
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center">
                <div class="text-muted mb-2">No session data available for this question.</div>
                <div class="text-small text-muted">
                    {% if result.benchmark == 'personamem' %}
                    Session data should exist for PersonaMem. Check if <code>shared_contexts_32k.jsonl</code> is present.
                    {% else %}
                    Session display is only available for PersonaMem benchmark questions.
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Ingestion Tab -->
    <div id="tab-ingestion" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Ingestion Metrics</h3>
            </div>
            <div class="card-body">
                {% if deep_log and deep_log.ingestion %}
                <div class="grid grid-4 mb-4">
                    <div class="stat-card" style="background: var(--bg-input);">
                        <div class="stat-label">Nodes Created</div>
                        <div class="stat-value">{{ deep_log.ingestion.nodes_created or 0 }}</div>
                    </div>
                    <div class="stat-card" style="background: var(--bg-input);">
                        <div class="stat-label">Edges Created</div>
                        <div class="stat-value">{{ deep_log.ingestion.relationships_created or 0 }}</div>
                    </div>
                    <div class="stat-card" style="background: var(--bg-input);">
                        <div class="stat-label">Sessions</div>
                        <div class="stat-value">{{ deep_log.ingestion.sessions_count or 0 }}</div>
                    </div>
                    <div class="stat-card" style="background: var(--bg-input);">
                        <div class="stat-label">Duration</div>
                        <div class="stat-value">{{ "%.2f"|format((deep_log.ingestion.duration_ms or 0) / 1000) }}s</div>
                    </div>
                </div>
                
                {% if deep_log.ingestion.memories_created %}
                {% set mem = deep_log.ingestion.memories_created %}
                {% set has_persona_types = (mem.psyche or 0) > 0 or (mem.goals or 0) > 0 %}
                {% if has_persona_types %}
                <h4>Memories Created</h4>
                <div class="table-wrapper mt-2">
                    <table>
                        <thead>
                            <tr><th>Type</th><th>Count</th></tr>
                        </thead>
                        <tbody>
                            {% for type, count in mem.items() %}
                            {% if count > 0 %}
                            <tr><td>{{ type }}</td><td>{{ count }}</td></tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
                {% endif %}
                {% else %}
                <div class="text-muted">No ingestion data recorded.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Retrieval Tab -->
    <div id="tab-retrieval" class="tab-content">
        {% set graph_traversal = deep_log.retrieval.graph_traversal if deep_log and deep_log.retrieval else {} %}
        {% set final_nodes = graph_traversal.final_ranked_nodes if graph_traversal else [] %}
        {% set nodes_visited = graph_traversal.nodes_visited if graph_traversal else 0 %}
        {% set edges_traversed = graph_traversal.relationships_traversed if graph_traversal else 0 %}
        
        <!-- LLM Context Card - Most Important -->
        <div class="card" style="border-color: var(--color-primary); border-width: 2px;">
            <div class="card-header" style="background: var(--color-primary-dim);">
                <h3 class="card-title" style="color: var(--color-primary);">Context Passed to LLM</h3>
                <span class="badge" style="background: var(--color-primary-dim); color: var(--color-primary); border: 1px solid var(--color-primary);">Critical for Debugging</span>
            </div>
            <div class="card-body">
                <p class="text-small text-muted mb-3">This is the exact context string the memory system constructed and passed to the LLM for answer generation. This is what the model "sees" from memory.</p>
                {% if deep_log and deep_log.retrieval and deep_log.retrieval.retrieved_context %}
                <div class="code-block" style="max-height: 500px; overflow-y: auto; background: #0a0c10; border: 1px solid var(--color-primary-dim);">
                    <pre style="white-space: pre-wrap; word-break: break-word;">{{ deep_log.retrieval.retrieved_context }}</pre>
                </div>
                <div class="mt-2 text-small text-muted">
                    {{ deep_log.retrieval.retrieved_context|length }} characters
                </div>
                {% else %}
                <div class="text-center" style="padding: 40px; background: var(--bg-input); border-radius: var(--radius-md);">
                    <div class="text-warning mb-2">No context string captured</div>
                    <div class="text-small text-muted">
                        The adapter may not be logging <code>retrieved_context</code> in the retrieval step.<br>
                        Ensure your adapter returns <code>{"retrieved_context": "..."}</code> in deep logs.
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Retrieval Metrics -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Retrieval Metrics</h3>
            </div>
            <div class="card-body">
                {% if final_nodes or retrieved_nodes %}
                <div class="grid grid-3 mb-4">
                    <div class="stat-card" style="background: var(--bg-input);">
                        <div class="stat-label">Nodes Retrieved</div>
                        <div class="stat-value">{{ nodes_visited or retrieved_nodes|length }}</div>
                    </div>
                    <div class="stat-card" style="background: var(--bg-input);">
                        <div class="stat-label">Edges Traversed</div>
                        <div class="stat-value">{{ edges_traversed }}</div>
                    </div>
                    <div class="stat-card" style="background: var(--bg-input);">
                        <div class="stat-label">Duration</div>
                        <div class="stat-value">{{ (pipeline.retrieval.duration_ms or 0)|int }}ms</div>
                    </div>
                </div>
                {% else %}
                <div class="text-muted">No retrieval metrics available.</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Retrieved Nodes -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Retrieved Nodes</h3>
                <span class="text-small text-muted">Node IDs from graph/vector search</span>
            </div>
            <div class="card-body">
                {% if final_nodes %}
                <div class="text-small text-warning mb-3" style="padding: 8px 12px; background: var(--color-warning-dim); border-radius: var(--radius-sm);">
                    Note: Only node UUIDs are logged. To see node content, enable <code>log_node_content=True</code> in your adapter.
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 60px;">Rank</th>
                                <th>Node UUID</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for node_id in final_nodes[:20] %}
                            <tr>
                                <td class="text-center font-bold">#{{ loop.index }}</td>
                                <td class="text-mono text-small">{{ node_id }}</td>
                            </tr>
                            {% endfor %}
                            {% if final_nodes|length > 20 %}
                            <tr>
                                <td colspan="2" class="text-muted text-center">... and {{ final_nodes|length - 20 }} more nodes</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                {% elif retrieved_nodes %}
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 60px;">Rank</th>
                                <th>Score</th>
                                <th>Node ID</th>
                                <th>Type</th>
                                <th>Content</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for node in retrieved_nodes %}
                            <tr>
                                <td class="text-center font-bold">#{{ node.retrieval_rank or loop.index }}</td>
                                <td class="text-mono">{{ "%.4f"|format(node.similarity_score) if node.similarity_score else '-' }}</td>
                                <td class="text-mono text-small">{{ node.node_id[:16] }}...</td>
                                <td><span class="badge badge-outline">{{ node.node_type or 'node' }}</span></td>
                                <td class="text-small">{{ node.node_content[:100] if node.node_content else '-' }}{% if node.node_content and node.node_content|length > 100 %}...{% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-muted text-center" style="padding: 20px;">No nodes retrieved or logged.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Generation Tab -->
    <div id="tab-gen" class="tab-content">
        <div class="card">
             <div class="card-header">
                <h3 class="card-title">Generation Details</h3>
            </div>
            <div class="card-body">
                <div class="flex gap-4 mb-4">
                    <div>
                        <span class="text-small text-muted block">Model</span>
                        <span class="font-bold">{{ pipeline.generation.model or 'Unknown' }}</span>
                    </div>
                    <div>
                        <span class="text-small text-muted block">Duration</span>
                        <span class="font-bold">{{ pipeline.generation.duration_ms }}ms</span>
                    </div>
                </div>
                
                <h4>Full Answer</h4>
                <div class="code-block" style="white-space: pre-wrap; font-family: var(--font-stack); font-size: 14px;">{{ result.generated_answer }}</div>
            </div>
        </div>
    </div>

    <!-- Raw Tab -->
    <div id="tab-raw" class="tab-content">
        <div class="card">
            <div class="card-body">
                <div class="code-block">
                    <pre>{{ deep_log | tojson(indent=2) }}</pre>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
