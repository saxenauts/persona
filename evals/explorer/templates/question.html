{% extends "base.html" %}

{% block title %}{{ result.question_id }} - Eval Explorer{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/">Runs</a> / 
    {% if run_id %}<a href="/run/{{ run_id }}">{{ run_id }}</a> / {% endif %}
    {{ result.question_id }}
</div>

<div class="card mb-4">
    <div class="flex" style="align-items: flex-start;">
        <div class="flex-1">
            <h2>Question</h2>
            <p style="font-size: 16px; margin-bottom: 16px;">{{ result.question_text }}</p>
            
            <div class="grid grid-2" style="gap: 12px;">
                <div>
                    <span class="text-muted text-sm">Expected Answer:</span>
                    <code class="text-success" style="font-size: 18px;">{{ result.gold_answer }}</code>
                </div>
                <div>
                    <span class="text-muted text-sm">Generated Answer:</span>
                    <code class="{% if result.correct %}text-success{% else %}text-error{% endif %}" style="font-size: 18px;">
                        {{ result.generated_answer[:50] if result.generated_answer else 'None' }}
                    </code>
                </div>
            </div>
        </div>
        <div style="text-align: right; min-width: 150px;">
            <div class="badge {% if result.correct %}badge-success{% else %}badge-error{% endif %}" style="font-size: 14px; padding: 6px 12px;">
                {% if result.correct %}CORRECT{% else %}FAILED{% endif %}
            </div>
            {% if result.failure_category %}
            <div class="badge badge-warning" style="margin-top: 8px; display: block;">
                {{ result.failure_category }}
            </div>
            {% endif %}
            <div class="text-muted text-sm" style="margin-top: 12px;">
                Type: {{ result.question_type }}
            </div>
        </div>
    </div>
</div>

<div class="tabs">
    <button class="tab active" data-tab="tab-sessions">Sessions ({{ sessions|length if sessions else 0 }})</button>
    <button class="tab" data-tab="tab-retrieval">Retrieval ({{ retrieved_nodes|length }})</button>
    <button class="tab" data-tab="tab-context">Generated Context</button>
    {% if deep_log %}<button class="tab" data-tab="tab-raw">Raw Log</button>{% endif %}
</div>

<div id="tab-sessions" class="tab-content active">
    <div class="card">
        {% if sessions %}
            {% for session in sessions %}
            <div style="margin-bottom: 24px;">
                <h3 style="font-size: 14px; color: var(--text-muted); margin-bottom: 12px;">
                    Conversation ({{ session|length }} turns)
                </h3>
                {% for turn in session[:50] %}
                <div class="message message-{{ turn.role|lower }}">
                    <div class="message-role">{{ turn.role }}</div>
                    <div>{{ turn.content[:500] }}{% if turn.content|length > 500 %}...{% endif %}</div>
                </div>
                {% endfor %}
                {% if session|length > 50 %}
                <div class="text-muted text-sm" style="padding: 12px;">
                    ... and {{ session|length - 50 }} more turns
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">No session data available for this question.</p>
        {% endif %}
    </div>
</div>

<div id="tab-retrieval" class="tab-content">
    <div class="card">
        <h2>Retrieved Nodes ({{ retrieved_nodes|length }})</h2>
        {% if retrieved_nodes %}
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Node ID</th>
                    <th>Type</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody>
                {% for node in retrieved_nodes %}
                <tr>
                    <td>{{ node.retrieval_rank }}</td>
                    <td><code class="text-sm">{{ node.node_id[:12] }}...</code></td>
                    <td>{{ node.node_type or '-' }}</td>
                    <td>{{ "%.3f"|format(node.similarity_score) if node.similarity_score else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted">No retrieval data in database. Check deep_log tab for full context.</p>
        {% endif %}
    </div>
</div>

<div id="tab-context" class="tab-content">
    <div class="card">
        <h2>Context Given to LLM</h2>
        {% if deep_log and deep_log.retrieval %}
        <pre><code>{{ deep_log.retrieval.retrieved_context }}</code></pre>
        {% else %}
        <p class="text-muted">No context data available.</p>
        {% endif %}
    </div>
</div>

{% if deep_log %}
<div id="tab-raw" class="tab-content">
    <div class="card">
        <h2>Raw Deep Log</h2>
        <pre><code>{{ deep_log | tojson(indent=2) }}</code></pre>
    </div>
</div>
{% endif %}

{% endblock %}
