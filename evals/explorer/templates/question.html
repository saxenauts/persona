{% extends "base.html" %}

{% block title %}{{ result.question_id }} - Eval Explorer{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/">Runs</a> / 
    {% if run_id %}<a href="/run/{{ run_id }}">{{ run_id }}</a> / {% endif %}
    {{ result.question_id }}
</div>

<div class="card mb-4">
    <div class="flex" style="align-items: flex-start;">
        <div class="flex-1">
            <h2>Question</h2>
            <p style="font-size: 16px; margin-bottom: 16px;">{{ result.question_text }}</p>
            
            <div class="grid grid-2" style="gap: 12px;">
                <div>
                    <span class="text-muted text-sm">Expected Answer:</span>
                    <code class="text-success" style="font-size: 18px;">{{ result.gold_answer }}</code>
                </div>
                <div>
                    <span class="text-muted text-sm">Generated Answer:</span>
                    <code class="{% if result.correct %}text-success{% else %}text-error{% endif %}" style="font-size: 18px;">
                        {{ result.generated_answer[:50] if result.generated_answer else 'None' }}
                    </code>
                </div>
            </div>
        </div>
        <div style="text-align: right; min-width: 150px;">
            <div class="badge {% if result.correct %}badge-success{% else %}badge-error{% endif %}" style="font-size: 14px; padding: 6px 12px;">
                {% if result.correct %}CORRECT{% else %}FAILED{% endif %}
            </div>
            {% if result.failure_category %}
            <div class="badge badge-warning" style="margin-top: 8px; display: block;">
                {{ result.failure_category }}
            </div>
            {% endif %}
            <div class="text-muted text-sm" style="margin-top: 12px;">
                Type: {{ result.question_type }}
            </div>
        </div>
    </div>
</div>

<div class="tabs">
    <button class="tab active" data-tab="tab-sessions">Sessions ({{ sessions|length if sessions else 0 }})</button>
    <button class="tab" data-tab="tab-ingestion">Ingestion</button>
    <button class="tab" data-tab="tab-retrieval">Retrieval ({{ retrieved_nodes|length }})</button>
    <button class="tab" data-tab="tab-context">Generated Context</button>
    {% if deep_log %}<button class="tab" data-tab="tab-raw">Raw Log</button>{% endif %}
</div>

<div id="tab-sessions" class="tab-content active">
    <div class="card">
        {% if sessions %}
            <div class="sessions-legend mb-4">
                <span class="legend-item"><span class="legend-dot gold-dot"></span> Contains gold answer</span>
                <span class="legend-item"><span class="legend-dot"></span> No gold answer found</span>
            </div>
            {% for session in sessions %}
            <div class="session-container {% if session.contains_gold %}session-gold{% endif %}">
                <div class="session-header" onclick="toggleSession({{ session.id }})">
                    <span class="session-toggle" id="toggle-{{ session.id }}">▶</span>
                    <span class="session-title">
                        Session {{ session.id + 1 }}
                        <span class="text-muted text-sm">({{ session.turns|length }} turns)</span>
                    </span>
                    {% if session.contains_gold %}
                    <span class="badge badge-success" style="margin-left: 8px;">Contains Gold</span>
                    {% endif %}
                </div>
                <div class="session-content" id="session-{{ session.id }}" style="display: none;">
                    {% for turn in session.turns[:100] %}
                    <div class="message message-{{ turn.role|lower }}">
                        <div class="message-role-badge {{ turn.role|lower }}">{{ turn.role }}</div>
                        <div class="message-content">{{ turn.content[:1000] }}{% if turn.content|length > 1000 %}...{% endif %}</div>
                    </div>
                    {% endfor %}
                    {% if session.turns|length > 100 %}
                    <div class="text-muted text-sm" style="padding: 12px;">
                        ... and {{ session.turns|length - 100 }} more turns
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">No session data available for this question.</p>
        {% endif %}
    </div>
</div>

<div id="tab-ingestion" class="tab-content">
    <div class="card">
        <h2>Ingestion Summary</h2>
        {% if deep_log and deep_log.ingestion %}
        <div class="grid grid-4 mb-4">
            <div class="stat">
                <div class="stat-value">{{ deep_log.ingestion.sessions_count or 0 }}</div>
                <div class="stat-label">Sessions</div>
            </div>
            <div class="stat">
                <div class="stat-value">{{ deep_log.ingestion.nodes_created or 0 }}</div>
                <div class="stat-label">Nodes Created</div>
            </div>
            <div class="stat">
                <div class="stat-value">{{ deep_log.ingestion.relationships_created or 0 }}</div>
                <div class="stat-label">Relationships</div>
            </div>
            <div class="stat">
                <div class="stat-value">{{ "%.1f"|format((deep_log.ingestion.duration_ms or 0) / 1000) }}s</div>
                <div class="stat-label">Duration</div>
            </div>
        </div>
        {% if deep_log.ingestion.memories_created %}
        <h3 style="margin-top: 16px;">Memories Created</h3>
        <table>
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Count</th>
                </tr>
            </thead>
            <tbody>
                {% for type, count in deep_log.ingestion.memories_created.items() %}
                <tr>
                    <td>{{ type }}</td>
                    <td>{{ count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
        {% if deep_log.ingestion.errors %}
        <h3 style="margin-top: 16px; color: var(--error);">Errors</h3>
        <pre><code>{{ deep_log.ingestion.errors | tojson(indent=2) }}</code></pre>
        {% endif %}
        {% else %}
        <p class="text-muted">No ingestion data available.</p>
        {% endif %}
    </div>
</div>

<div id="tab-retrieval" class="tab-content">
    <div class="card">
        <h2>Retrieved Nodes ({{ retrieved_nodes|length }})</h2>
        {% if retrieved_nodes %}
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Node ID</th>
                    <th>Type</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody>
                {% for node in retrieved_nodes %}
                <tr>
                    <td>{{ node.retrieval_rank }}</td>
                    <td><code class="text-sm">{{ node.node_id[:12] }}...</code></td>
                    <td>{{ node.node_type or '-' }}</td>
                    <td>{{ "%.3f"|format(node.similarity_score) if node.similarity_score else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted">No retrieval data in database. Check deep_log tab for full context.</p>
        {% endif %}
    </div>
</div>

<div id="tab-context" class="tab-content">
    <div class="card">
        <h2>Context Given to LLM</h2>
        {% if deep_log and deep_log.retrieval %}
        <pre><code>{{ deep_log.retrieval.retrieved_context }}</code></pre>
        {% else %}
        <p class="text-muted">No context data available.</p>
        {% endif %}
    </div>
</div>

{% if deep_log %}
<div id="tab-raw" class="tab-content">
    <div class="card">
        <h2>Raw Deep Log</h2>
        <pre><code>{{ deep_log | tojson(indent=2) }}</code></pre>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
function toggleSession(id) {
    const content = document.getElementById('session-' + id);
    const toggle = document.getElementById('toggle-' + id);
    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = '▼';
    } else {
        content.style.display = 'none';
        toggle.textContent = '▶';
    }
}

function expandAll() {
    document.querySelectorAll('.session-content').forEach(el => el.style.display = 'block');
    document.querySelectorAll('.session-toggle').forEach(el => el.textContent = '▼');
}

function collapseAll() {
    document.querySelectorAll('.session-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.session-toggle').forEach(el => el.textContent = '▶');
}
</script>
{% endblock %}
